<!DOCTYPE html>
<meta charset="utf-8">
<html>
  <head>
    <title>ZIP Code Heatmap</title>
    <style>
      #controls {
        display: none;
      }
      .zip {
        fill: none;
        stroke: #CCC;
        stroke-width: .5px;
      }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script>
    $(document).ready(function () {
      var width = 960,
      height = 500;

      var path = d3.geo.path();

      var svg = d3.select("body").append("svg")
      .attr("width", width)
      .attr("height", height);

      queue()
      // .defer(d3.json, "zips_us_topo.json")
      .defer(d3.json, "https://gist.githubusercontent.com/jefffriesen/6892860/raw/e1f82336dde8de0539a7bac7b8bc60a23d0ad788/zips_us_topo.json")
      .await(function (error, us) {
        svg.append("g")
        .attr("class", "counties")
        .selectAll("path")
        .data(topojson.feature(us, us.objects.zip_codes_for_the_usa).features)
        .enter().append("path")
        .attr("class", "zip")
        .attr("id", function(d) {return d.properties.zip; })
        .attr("data-state", function(d) {return d.properties.state; })
        .attr("data-name", function(d) {return d.properties.name; })
        .attr("d", path);
        $('#controls').show();
      });


      let colorize = function(percent) {
        let r, g, b = 0;
        if (percent < 50) {
          r = 255;
          g = Math.round(5.1 * percent);
        } else {
          g = 255;
          r = Math.round(510 - 5.10 * percent);
        }
        let h = r * 0x10000 + g * 0x100 + b * 0x1;
        return '#' + ('000000' + h.toString(16)).slice(-6);
      }

      $('#button').click(function () {
        d3.csv("iou_zipcodes_2020.csv", function(data) {
          // Format: [{zip: '85321', rate: '0.0938871473'}]
          let zipcode, color = '';
          $.each(data, function (key, val) {
            zipcode = val['zip'];
            color = colorize(Math.min(500 * val['rate'], 100));
            $('#' + zipcode).css('fill',color);
          });
        });
      });
    });
    </script>
  </head>
  <body>
    <div id="controls">
        <button type="button" id="button">Click me</button>
        <div id="info"></div>
    </div>
  </body>
</html>